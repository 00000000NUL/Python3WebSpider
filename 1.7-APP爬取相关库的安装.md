## 1.7　App爬取相关库的安装

除了Web网页，爬虫也可以抓取App的数据。App中的页面要加载出来，首先需要获取数据，而这些数据一般是通过请求服务器的接口来获取的。由于App没有浏览器这种可以比较直观地看到后台请求的工具，所以主要用一些抓包技术来抓取数据。

本书介绍的抓包工具有Charles、mitmproxy和mitmdump。一些简单的接口可以通过Charles或mitmproxy分析，找出规律，然后直接用程序模拟来抓取了。但是如果遇到更复杂的接口，就需要利用mitmdump对接Python来对抓取到的请求和响应进行实时处理和保存。另外，既然要做规模采集，就需要自动化App的操作而不是人工去采集，所以这里还需要一个工具叫作Appium，它可以像Selenium一样对App进行自动化控制，如自动化模拟App的点击、下拉等操作。

本节中，我们就来介绍一下Charles、mitmproxy、mitmdump、Appium的安装方法。

### 1.7.1　Charles的安装

Charles是一个网络抓包工具，相比Fiddler，其功能更为强大，而且跨平台支持得更好，所以这里选用它来作为主要的移动端抓包工具。

#### 1. 相关链接

官方网站：https://www.charlesproxy.com

下载链接：https://www.charlesproxy.com/download

#### 2. 下载Charles

我们可以在官网下载最新的稳定版本，如图1-42所示。可以发现，它支持Windows、Linux和Mac三大平台。

![1-43{407}](../../../../../../../api/storage/getbykey/original)

图1-42　Charles下载页面

直接点击对应的安装包下载即可，具体的安装过程这里不再赘述。

Charles是收费软件，不过可以免费试用30天。如果试用期过了，其实还可以试用，不过每次试用不能超过30分钟，启动有10秒的延时，但是完整的软件功能还是可以使用的，所以还算比较友好。

#### 3. 证书配置

现在很多页面都在向HTTPS方向发展，HTTPS通信协议应用得越来越广泛。如果一个App通信应用了HTTPS协议，那么它通信的数据都会是被加密的，常规的截包方法是无法识别请求内部的数据的。

安装完成后，如果我们想要做HTTPS抓包的话，那么还需要配置一下相关SSL证书。接下来，我们再看看各个平台下的证书配置过程。

Charles是运行在PC端的，我们要抓取的是App端的数据，所以要在PC和手机端都安装证书。

##### Windows

如果你的PC是Windows系统，可以按照下面的操作进行证书配置。

首先打开Charles，点击Help→SSL Proxying→Install Charles Root Certificate，即可进入证书的安装页面，如图1-43所示。

![1-44{421}](../../../../../../../api/storage/getbykey/original)

图1-43　证书安装页面入口

接下来，会弹出一个安装证书的页面，如图1-44所示。

![1-45{199}](../../../../../../../api/storage/getbykey/original)

图1-44　证书安装页面

点击“安装证书”按钮，就会打开证书导入向导，如图1-45所示。

直接点击“下一步”按钮，此时需要选择证书的存储区域，点击第二个选项“将所有的证书放入下列存储”，然后点击“浏览”按钮，从中选择证书存储位置为“受信任的根证书颁发机构”，再点击“确定”按钮，然后点击“下一步”按钮，如图1-46所示。

|                      |                          |
| -------------------- | ------------------------ |
| 图1-45　证书导入向导 | 图1-46　选择证书存储区域 |

再继续点击“下一步”按钮完成导入。

##### Mac

如果你的PC是Mac系统，可以按照下面的操作进行证书配置。

同样是点击Help→SSL Proxying→Install Charles Root Certificate，即可进入证书的安装页面。

接下来，找到Charles的证书并双击，将“信任”设置为“始终信任”即可，如图1-47所示。

![1-48{310}](../../../../../../../api/storage/getbykey/original)

图1-47　证书配置

这样就成功安装了证书。

##### iOS

如果你的手机是iOS系统，可以按照下面的操作进行证书配置。

首先，查看电脑的Charles代理是否开启，具体操作是点击Proxy→Proxy Settings，打开代理设置页面，确保当前的HTTP代理是开启的，如图1-48所示。这里的代理端口为8888，也可以自行修改。

接下来，将手机和电脑连在同一个局域网下。例如，当前电脑的IP为192.168.1.76，那么首先设置手机的代理为192.168.1.76:8888，如图1-49所示。

|                  |                  |
| ---------------- | ---------------- |
| 图1-48　代理设置 | 图1-49　代理设置 |

设置完毕后，电脑上会出现一个提示窗口，询问是否信任此设备，如图1-50所示。

![1-51{422}](../../../../../../../api/storage/getbykey/original)

图1-50　提示窗口

此时点击Allow按钮即可。这样手机就和PC连在同一个局域网内了，而且设置了Charles的代理，即Charles可以抓取到流经App的数据包了。

接下来，再安装Charles的HTTPS证书。

在电脑上打开Help→SSL Proxying→Install Charles Root Certificate on a Mobile Device or Remote Browser，如图1-51所示。

![1-52{247}](../../../../../../../api/storage/getbykey/original)

图1-51　证书安装页面入口

此时会看到如图1-52所示的提示。

![1-53{422}](../../../../../../../api/storage/getbykey/original)

图1-52　提示窗口

它提示我们在手机上设置好Charles的代理（刚才已经设置好了），然后在手机浏览器中打开chls.pro/ssl下载证书。

在手机上打开chls.pro/ssl后，便会弹出证书的安装页面，如图1-53所示。

点击“安装”按钮，然后输入密码即可完成安装，如图1-54所示。

如果你的iOS版本是10.3以下的话，信任CA证书的流程就已经完成了。

如果你的iOS版本是10.3及以上，还需要在“设置”→“通用”→“关于本机”→“证书信任设置”中将证书的完全信任开关打开，如图1-55所示。

|                      |                      |                      |
| -------------------- | -------------------- | -------------------- |
| 图1-53　证书安装页面 | 图1-54　安装成功页面 | 图1-55　证书信任设置 |

##### Android

如果你的手机是Android系统，可以按照下面的操作进行证书配置。

在Android系统中，同样需要设置代理为Charles的代理，如图1-56所示。

设置完毕后，电脑上就会出现一个提示窗口，询问是否信任此设备，如图1-50所示，此时直接点击Allow按钮即可。

接下来，像iOS设备那样，在手机浏览器上打开chls.pro/ssl，这时会出现一个提示框，如图1-57所示。

|                  |                      |
| ---------------- | -------------------- |
| 图1-56　代理设置 | 图1-57　证书安装页面 |

我们为证书添加一个名称，然后点击“确定”按钮即可完成证书的安装。

#### 4. 开启SSL监听

点击Proxy→SSLProxying Settings，在弹出的窗口中点击 Add 按钮，添加需要监听的地址和端口。如果需要监听所有的 HTTPS 请求，可以直接将地址和端口设置为 *，即添加一条 *:* 的配置，如图1-58所示。这样配置好了，我们就可以抓到所有 HTTPS 请求包了。如果不配置的话，抓到的 HTTPS 请求包状态可能是 unknown。

![C:\Users\ADMINI~1\AppData\Local\Temp\WeChat Files\392615843979114671.jpg{348}](../../../../../../../api/storage/getbykey/original)

图1-58　SSL Proxying Settings

### 1.7.2　mitmproxy的安装

mitmproxy是一个支持HTTP和HTTPS的抓包程序，类似Fiddler、Charles的功能，只不过它通过控制台的形式操作。

此外，mitmproxy还有两个关联组件，一个是mitmdump，它是mitmproxy的命令行接口，利用它可以对接Python脚本，实现监听后的处理；另一个是mitmweb，它是一个Web程序，通过它以清楚地观察到mitmproxy捕获的请求。

本节中，我们就来了解一下mitmproxy、mitmdump和mitmweb的安装方式。

#### 1. 相关链接

GitHub：https://github.com/mitmproxy/mitmproxy

官方网站：https://mitmproxy.org

PyPI：https://pypi.python.org/pypi/mitmproxy

官方文档：http://docs.mitmproxy.org

mitmdump脚本：http://docs.mitmproxy.org/en/stable/scripting/overview.html

下载地址：https://github.com/mitmproxy/mitmproxy/releases

DockerHub：https://hub.docker.com/r/mitmproxy/mitmproxy

#### 2. pip安装

最简单的安装方式还是使用pip，直接执行如下命令即可安装：

pip3 install mitmproxy

这是最简单和通用的安装方式，执行完毕之后即可完成mitmproxy的安装，另外还附带安装了mitmdump和mitmweb这两个组件。如果不想用这种方式安装，也可以选择后面列出的专门针对各个平台的安装方式或者Docker安装方式。

#### 3. Windows下的安装

可以到GitHub上的Releases页面（链接为：https://github.com/mitmproxy/mitmproxy/releases/）获取安装包，如图1-59所示。

![1-60{383}](../../../../../../../api/storage/getbykey/original)

图1-59　下载页面

比如，当前的最新版本为2.0.2，则可以选择下载Windows下的exe安装包mitmproxy-2.0.2-windows-  
installer.exe，下载后直接双击安装包即可安装。

注意，在Windows上不支持mitmproxy的控制台接口，但是可以使用mitmdump和mitmweb。

#### 4. Linux下的安装

在Linux下，可以下载编译好的二进制包（下载地址https://github.com/mitmproxy/mitmproxy/  
releases/），此发行包一般是最新版本，它包含了最新版本的mitmproxy和内置的Python 3环境，以及最新的OpenSSL环境。

如果你的环境里没有Python 3和OpenSSL环境，建议使用此种方式安装。

下载之后，需要解压并将其配置到环境变量：

tar -zxvf mitmproxy-2.0.2-linux.tar.gz  
sudo mv mitmproxy mitmdump mitmweb /usr/bin

这样就可以将3个可执行文件移动到了/usr/bin目录。而一般情况下，/usr/bin目录都已经配置在了环境变量下，所以接下来可以直接调用这3个工具了。

#### 5. Mac下的安装

Mac下的安装非常简单，直接使用Homebrew即可，命令如下：

brew install mitmproxy

执行命令后，即可完成mitmproxy的安装。

#### 6. Docker安装

mitmproxy也支持Docker，其DockerHub的地址为https://hub.docker.com/r/mitmproxy/mitmproxy/。

在Docker下，mitmproxy的安装命令为：

docker run --rm -it -p 8080:8080 mitmproxy/mitmproxy mitmdump

这样就在8080端口上启动了mitmproxy和mitmdump。

如果想要获取CA证书，可以选择挂载磁盘选项，命令如下：

docker run --rm -it -v ~/.mitmproxy:/home/mitmproxy/.mitmproxy -p 8080:8080 mitmproxy/mitmproxy mitmdump

这样就可以在~/.mitmproxy目录下找到CA证书。

另外，还可以在8081端口上启动mitmweb，命令如下：

docker run --rm -it -p 8080:8080 -p 127.0.0.1:8081:8081 mitmproxy/mitmproxy mitmweb

更多启动方式可以参考Docker Hub的安装说明。

#### 7. 证书配置

对于mitmproxy来说，如果想要截获HTTPS请求，就需要设置证书。mitmproxy在安装后会提供一套CA证书，只要客户端信任了mitmproxy提供的证书，就可以通过mitmproxy获取HTTPS请求的具体内容，否则mitmproxy是无法解析HTTPS请求的。

首先，运行以下命令产生CA证书，并启动mitmdump：

mitmdump

接下来，我们就可以在用户目录下的.mitmproxy目录里面找到CA证书，如图1-60所示。

![1-61{333}](../../../../../../../api/storage/getbykey/original)

图1-60　证书文件

证书一共5个，表1-1简要说明了这5个证书。

表1-1　5个证书及其说明

| 名　　称              | 描　　述                                                     |
| --------------------- | ------------------------------------------------------------ |
| mitmproxy-ca.pem      | PEM格式的证书私钥                                            |
| mitmproxy-ca-cert.pem | PEM格式证书，适用于大多数非Windows平台                       |
| mitmproxy-ca-cert.p12 | PKCS12格式的证书，适用于Windows平台                          |
| mitmproxy-ca-cert.cer | 与mitmproxy-ca-cert.pem相同，只是改变了后缀，适用于部分Android平台 |
| mitmproxy-dhparam.pem | PEM格式的秘钥文件，用于增强SSL安全性                         |

下面我们介绍一下Windows、Mac、iOS和Android平台下的证书配置过程。

##### Windows

双击mitmproxy-ca.p12，就会出现导入证书的引导页，如图1-61所示。

直接点击“下一步”按钮即可，会出现密码设置提示，如图1-62所示。

|                      |                      |
| -------------------- | -------------------- |
| 图1-61　证书导入向导 | 图1-62　密码设置提示 |

这里不需要设置密码，直接点击“下一步”按钮即可。

接下来需要选择证书的存储区域，如图1-63所示。这里点击第二个选项“将所有的证书都放入下列存储”，然后点击“浏览”按钮，选择证书存储位置为“受信任的根证书颁发机构”，接着点击“确定”按钮，然后点击“下一步”按钮。

最后，如果有安全警告弹出，如图1-64所示，直接点击“是”按钮即可。

|                          |                  |
| ------------------------ | ---------------- |
| 图1-63　选择证书存储区域 | 图1-64　安全警告 |

这样就在Windows下配置完CA证书了。

##### Mac

Mac下双击mitmproxy-ca-cert.pem即可弹出钥匙串管理页面，然后找到mitmproxy证书，打开其设置选项，选择“始终信任”即可，如图1-65所示。

![1-66{336}](../../../../../../../api/storage/getbykey/original)

图1-65　证书配置

##### iOS

将mitmproxy-ca-cert.pem文件发送到iPhone上，推荐使用邮件方式发送，然后在iPhone上可以直接点击附件并识别安装，如图1-66所示。

点击“安装”按钮之后，会跳到安装描述文件的页面，点击“安装”按钮，此时会有警告提示，如图1-67所示。

继续点击右上角的“安装”按钮，安装成功之后会有已安装的提示，如图1-68所示。

|                      |                      |                      |
| -------------------- | -------------------- | -------------------- |
| 图1-66　证书安装页面 | 图1-67　安装警告页面 | 图1-68　安装成功页面 |

如果你的iOS版本是10.3以下的话，此处信任CA证书的流程就已经完成了。

如果你的iOS版本是10.3及以上版本，还需要在“设置”→“通用”→“关于本机”→“证书信任设置”将mitmproxy的完全信任开关打开，如图1-69所示。此时，在iOS上配置信任CA证书的流程就结束了。

##### Android

在Android手机上，同样需要将证书mitmproxy-ca-cert.pem文件发送到手机上，例如直接复制文件。

接下来，点击证书，便会出现一个提示窗口，如图1-70所示。

|                      |                      |
| -------------------- | -------------------- |
| 图1-69　证书信任设置 | 图1-70　证书安装页面 |

这时输入证书的名称，然后点击“确定”按钮即可完成安装。

### 1.7.3　Appium的安装

Appium是移动端的自动化测试工具，类似于前面所说的Selenium，利用它可以驱动Android、iOS等设备完成自动化测试，比如模拟点击、滑动、输入等操作，其官方网站为：http://appium.io/。本节中，我们就来了解一下Appium的安装方式。

#### 1. 相关链接

GitHub：https://github.com/appium/appium

官方网站：http://appium.io

官方文档：http://appium.io/introduction.html

下载链接：https://github.com/appium/appium-desktop/releases

Python Client：https://github.com/appium/python-client

#### 2. 安装Appium

首先，需要安装Appium。Appium负责驱动移动端来完成一系列操作，对于iOS设备来说，它使用苹果的UIAutomation来实现驱动；对于Android来说，它使用UIAutomator和Selendroid来实现驱动。

同时Appium也相当于一个服务器，我们可以向它发送一些操作指令，它会根据不同的指令对移动设备进行驱动，以完成不同的动作。

安装Appium有两种方式，一种是直接下载安装包Appium Desktop来安装，另一种是通过Node.js来安装，下面我们介绍一下这两种安装方式。

##### Appium Desktop

Appium Desktop支持全平台的安装，我们直接从GitHub的Releases里面安装即可，链接为https://github.com/appium/appium-desktop/releases。目前的最新版本是1.1，下载页面如图1-71所示。

![1-72{337}](../../../../../../../api/storage/getbykey/original)

图1-71　下载页面

Windows平台可以下载exe安装包appium-desktop-Setup-1.1.0.exe，Mac平台可以下载dmg安装包如appium-desktop-1.1.0.dmg，Linux平台可以选择下载源码，但是更推荐用Node.js安装方式。

安装完成后运行，看到的页面如图1-72所示。

![1-73{353}](../../../../../../../api/storage/getbykey/original)

图1-72　运行页面

如果出现此页面，则证明安装成功。

##### Node.js

首先需要安装Node.js，具体的安装方式可以参见http://www.runoob.com/nodejs/nodejs-install-  
setup.html，安装完成之后就可以使用npm命令了。

接下来，使用npm命令全局安装Appium即可：

npm install -g appium

此时等待命令执行完成即可，这样就成功安装了Appium。

#### 3. Android开发环境配置

如果我们要使用Android设备做App抓取的话，还需要下载和配置Android SDK，这里推荐直接安装Android Studio，其下载地址为https://developer.android.com/studio/index.html?hl=zh-cn。下载后直接安装即可。

然后，我们还需要下载Android SDK。直接打开首选项里面的Android SDK设置页面，勾选要安装的SDK版本，点击OK按钮即可下载和安装勾选的SDK版本，如图1-73所示。

![1-74{401}](../../../../../../../api/storage/getbykey/original)

图1-73　Android SDK设置页面

另外，还需要配置一下环境变量，添加ANDROID_HOME为Android SDK所在路径，然后再添加SDK文件夹下的tools和platform-tools文件夹到PATH中。

更详细的配置可以参考Android Studio的官方文档：https://developer.android.com/studio/intro/  
index.html。

#### 4. iOS开发环境

首先需要声明的是，Appium是一个做自动化测试的工具，用它来测试我们自己开发的App是完全没问题的，因为它携带的是开发证书（Development Certificate）。但如果我们想拿iOS设备来做数据爬取的话，那又是另外一回事了。一般情况下，我们做数据爬取都是使用现有的App，在iOS上一般都是通过App Store下载的，它携带的是分发证书（Distribution Certificate），而携带这种证书的应用都是禁止被测试的，所以只有获取ipa安装包再重新签名之后才可以被Appium测试，具体的方法这里不再展开阐述。

这里推荐直接使用Android来进行测试。如果你可以完成上述重签名操作，那么可以参考如下内容配置iOS开发环境。

Appium驱动iOS设备必须要在Mac下进行，Windows和Linux平台是无法完成的，所以下面介绍一下Mac平台的相关配置。

Mac平台需要的配置如下：

macOS 10.12及更高版本

Xcode 8及更高版本

配置满足要求之后，执行如下命令即可配置开发依赖的一些库和工具：

xcode-select --install

这样iOS部分的开发环境就配置完成了，我们就可以用iOS模拟器来进行测试和数据抓取了。

如果想要用真机进行测试和数据抓取，还需要额外配置其他环境，具体可以参考https://github.com/  
appium/appium/blob/master/docs/en/appium-setup/real-devices-ios.md。