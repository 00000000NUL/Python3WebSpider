# MitmDump爬取得到APP电子书信息

在这里我们用一个实例来练习一下MitmDump脚本的使用方法。

得到APP是罗辑思维出品的一款碎片时间学习的APP，其官方网站为[https://www.igetget.com](https://www.igetget.com)，得到APP内有很多学习资源值得学习，也推荐大家用一下，此处非广告。

不过得到APP没有对应的网页版，所以一些信息必须要通过APP才可以获取。这次我们通过抓取其APP来练习一下MitmDump的用法。

## 爬取目标

我们的爬取目标是APP内电子书版块的电子书信息，如图所示：

![](./assets/2017-07-21-21-45-51.jpg)


需要把图书的名称、简介、封面、价格爬取下来，不过这次爬取的侧重点还是了解MitmDump工具的用法，所以暂不涉及自动化爬取，APP的操作还是手动来滑动，MitmDump负责捕捉Response并将数据提取保存。

## 初步探索

在开始之前我们需要先将手机和PC连在同一个网络内并设置好代理，那接下来我们首先需要探寻一下当前的页面的Url和返回内容是怎样的形式。

首先写一个脚本如下：

```python
def response(flow):
    print(flow.request.url)
    print(flow.response.text)
```

在这里我们只是输出了Request的Url和Response的Body内容，也就是请求链接和响应内容这两个最关键的部分，将脚本保存名称为script.py。

接下来运行MitmDump，命令如下：

```
mitmdump -s script.py
```

接下来在手机上打开得到APP的电子书页面，这时我们便可以看到PC端控制台有相应输出，接着我们滑动页面加载更多电子书，观察一下控制台新出现的输出内容就是APP发出的新的加载请求，包含的就是下一页的电子书内容，控制台输出结果示例如下：

![](./assets/2017-07-21-21-57-53.png)


可以看到有一个Url为[https://dedao.igetget.com/v3/discover/bookList](https://dedao.igetget.com/v3/discover/bookList)的接口，其后面还加了一个sign参数，看Url的名称几乎可以确定这就是获取一页电子书列表的接口，在Url的下方输出的是响应的内容，是一个Json格式的字符串，我们将它格式化一下看下。


![](./assets/2017-07-21-22-23-22.png)

可以看到格式化后的内容包含一个c字段，其内又有一个list字段，这就很明显了，list的每个元素都包含价格、标题、描述等内容，看一下第一个返回结果，电子书为《情人》，而此时观察APP的内容也正是这本电子书，再对比一下描述的内容和价格，也是完全匹配的。


![](./assets/2017-07-21-22-29-34.jpg)


所以这就证明了当前接口就是获取电子书信息的接口，我们只需要从这个接口来获取内容就好了，然后将返回的结果解析一下，再保存到数据库即可。

## 数据抓取

接下来我们需要对接口做一下过滤限制，可以只抓取如上分析的接口即可，然后再提取结果中的对应字段即可。

所以我们将脚本修改如下：

```python
import json
from mitmproxy import ctx

def response(flow):
    url = 'https://dedao.igetget.com/v3/discover/bookList'
    if flow.request.url.startswith(url):
        text = flow.response.text
        data = json.loads(text)
        books = data.get('c').get('list')
        for book in books:
            ctx.log.info(str(book))
```

重新滑动电子书页面，这时我们就可以在PC端控制台观察到如下输出了：

![](./assets/2017-07-21-22-35-28.jpg)

可以看到现在输出了书籍的全部信息，一本一条，还是一个Json的形式。

### 提取保存

接下来我们需要做的就是将我们需要的信息提取下来，然后再保存到数据库中，数据库为了方便起见我们选择MongoDB。

所以脚本中还可以增加提取信息和保存信息的部分，修改如下：

```python
import json
import pymongo
from mitmproxy import ctx

client = pymongo.MongoClient('localhost')
db = client['igetget']
collection = db['books']


def response(flow):
    global collection
    url = 'https://dedao.igetget.com/v3/discover/bookList'
    if flow.request.url.startswith(url):
        text = flow.response.text
        data = json.loads(text)
        books = data.get('c').get('list')
        for book in books:
            data = {
                'title': book.get('operating_title'),
                'cover': book.get('cover'),
                'summary': book.get('other_share_summary'),
                'price': book.get('price')
            }
            ctx.log.info(str(data))
            collection.insert(data)
```

这时我们重新滑动页面，控制台便会输出如下信息：


![](./assets/2017-07-21-23-16-56.jpg)

现在输出的每一条内容便是经过提取之后的内容了，包含了电子书的标题、封面、描述、价格信息。

另外在最开头我们还声明了MongoDB的连接，提取出信息之后调用insert()方法将数据插入到数据库即可。

这时我们滑动几页，就可以发现现在所看到的所有书籍信息都被保存到MongoDB中了。

![](./assets/2017-07-21-23-19-49.jpg)

好，到此为止，我们利用一个非常简单的脚本就把得到APP的电子书信息保存下来了。

本节主要是为了熟悉MitmDump的使用及脚本的编写方法，通过这个实例我们可以学习到怎样实时地将APP的数据抓取下来的方法。

本节的源代码地址是：[https://github.com/Python3WebSpider/IGetGet](https://github.com/Python3WebSpider/IGetGet)




