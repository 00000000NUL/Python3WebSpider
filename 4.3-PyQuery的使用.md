# PyQuery的使用

在上一节我们介绍了BeautifulSoup的使用，它是一个非常强大的网页解析库，可有没有觉得它的一些方法使用有点不适应？有没有觉得它的CSS选择器功能没有那么强大？

如果你对WEB有所涉及，如果你比较喜欢用CSS选择器，如果你对jQuery有所了解，那么这里有一个更适合你的解析库——PyQuery。

接下来我们就来感受一下PyQuery的强大之处。

## 初始化

像BeautifulSoup一样，PyQuery初始化的时候也需要传入HTML数据源来初始化一个操作对象，它的初始化方式有多种，比如直接传入字符串，传入URL，传文件名。下面我们来详细介绍一下。

### 字符串初始化

```python
html = '''
<div>
    <ul>
         <li class="item-0">first item</li>
         <li class="item-1"><a href="link2.html">second item</a></li>
         <li class="item-0 active"><a href="link3.html"><span class="bold">third item</span></a></li>
         <li class="item-1 active"><a href="link4.html">fourth item</a></li>
         <li class="item-0"><a href="link5.html">fifth item</a></li>
     </ul>
 </div>
'''
from pyquery import PyQuery as pq
doc = pq(html)
print(doc('li'))
```

运行结果：

```html
<li class="item-0">first item</li>
<li class="item-1"><a href="link2.html">second item</a></li>
<li class="item-0 active"><a href="link3.html"><span class="bold">third item</span></a></li>
<li class="item-1 active"><a href="link4.html">fourth item</a></li>
<li class="item-0"><a href="link5.html">fifth item</a></li>
```

在这里我们首先引入了PyQuery这个对象，取别名为pq，然后声明了一个长HTML字符串，当作参数传递给PyQuery，这样就成功完成了初始化，然后接下来将初始化的对象传入CSS选择器，在这个实例中我们传入li节点，这样就可以选择所有的li节点，打印输出可以看到所有的li节点的HTML文本。

### URL初始化

初始化的参数不仅可以以字符串的形式传递，还可以传入网页的URL，在这里只需要指定参数为url即可。

```python
from pyquery import PyQuery as pq
doc = pq(url='http://cuiqingcai.com')
print(doc('title'))
```

运行结果：

```html
<title>静觅丨崔庆才的个人博客</title>
```

这样的话PyQuery会首先请求这个URL，然后用得到的HTML内容完成初始化，其实就相当于我们用网页的源代码以字符串的形式传递给PyQuery来初始化。

它与下面的功能是相同的：

```python
from pyquery import PyQuery as pq
import requests
doc = pq(requests.get('http://cuiqingcai.com').text)
print(doc('title'))
```

### 文件初始化

当然除了传递一个URL，还可以传递本地的文件名，参数指定为filename即可。

```python
from pyquery import PyQuery as pq
doc = pq(filename='demo.html')
print(doc('li'))
```

当然在这里需要有一个本地HTML文件demo.html，内容是待解析的HTML字符串。这样它会首先读取本地的文件内容，然后用文件内容以字符串的形式传递给PyQuery来初始化。

以上三种初始化方式均可，当然最常用的初始化方式还是以字符串形式传递。

## 基本CSS选择器

我们首先用一个实例来感受一下PyQuery的CSS选择器的用法。

```python
html = '''
<div id="container">
    <ul class="list">
         <li class="item-0">first item</li>
         <li class="item-1"><a href="link2.html">second item</a></li>
         <li class="item-0 active"><a href="link3.html"><span class="bold">third item</span></a></li>
         <li class="item-1 active"><a href="link4.html">fourth item</a></li>
         <li class="item-0"><a href="link5.html">fifth item</a></li>
     </ul>
 </div>
'''
from pyquery import PyQuery as pq
doc = pq(html)
print(doc('#container .list li'))
print(type(doc('#container .list li')))
```

运行结果：

```python
<li class="item-0">first item</li>
<li class="item-1"><a href="link2.html">second item</a></li>
<li class="item-0 active"><a href="link3.html"><span class="bold">third item</span></a></li>
<li class="item-1 active"><a href="link4.html">fourth item</a></li>
<li class="item-0"><a href="link5.html">fifth item</a></li>
<class 'pyquery.pyquery.PyQuery'>
```

在这里我们初始化PyQuery对象之后，传入了一个CSS选择器，`#container .list li`，意思是选取id为container的节点内部的class为list的节点内部的所有li节点。然后打印输出，可以看到成功获取到了符合条件的节点。

然后我们将它的类型打印输出，可以看到它的类型依然是PyQuery类型。

## 查找节点

下面我们介绍一些常用的查询函数，这些函数和jQuery中的函数用法也完全相同。

### 子节点

查找子节点需要用到find()方法，传入的参数是CSS选择器，我们还是以上面的HTML为例。

```python
from pyquery import PyQuery as pq
doc = pq(html)
items = doc('.list')
print(type(items))
print(items)
lis = items.find('li')
print(type(lis))
print(lis)
```

运行结果：

```python
<class 'pyquery.pyquery.PyQuery'>
<ul class="list">
    <li class="item-0">first item</li>
    <li class="item-1"><a href="link2.html">second item</a></li>
    <li class="item-0 active"><a href="link3.html"><span class="bold">third item</span></a></li>
    <li class="item-1 active"><a href="link4.html">fourth item</a></li>
    <li class="item-0"><a href="link5.html">fifth item</a></li>
</ul>
<class 'pyquery.pyquery.PyQuery'>
<li class="item-0">first item</li>
<li class="item-1"><a href="link2.html">second item</a></li>
<li class="item-0 active"><a href="link3.html"><span class="bold">third item</span></a></li>
<li class="item-1 active"><a href="link4.html">fourth item</a></li>
<li class="item-0"><a href="link5.html">fifth item</a></li>
```

首先我们选取了class为list的节点，然后我们调用了find()方法，传入了CSS选择器，选取其内部的li节点，最后都打印输出即可观察到对应的查询结果，可以发现find()方法会将符合条件的所有节点选择出来，结果的类型是PyQuery类型。

其实find()的查找范围是节点的所有子孙节点，而如果我们只想查找子节点，那可以用children()方法。

```python
lis = items.children()
print(type(lis))
print(lis)
```

运行结果：

```python
<class 'pyquery.pyquery.PyQuery'>
<li class="item-0">first item</li>
<li class="item-1"><a href="link2.html">second item</a></li>
<li class="item-0 active"><a href="link3.html"><span class="bold">third item</span></a></li>
<li class="item-1 active"><a href="link4.html">fourth item</a></li>
<li class="item-0"><a href="link5.html">fifth item</a></li>
```

如果要筛选所有子节点中符合条件的节点，比如我们想筛选出子节点中class为active的节点，可以向children()方法传入CSS选择器`.active`。

```python
lis = items.children('.active')
print(lis)
```

运行结果：

```python
<li class="item-0 active"><a href="link3.html"><span class="bold">third item</span></a></li>
<li class="item-1 active"><a href="link4.html">fourth item</a></li>
```

可以看到输出的结果已经做了筛选，留下了class为active的节点。

### 父节点

我们可以用parent()方法来获取某个节点的父节点，我们用一个实例来感受一下：

```python
html = '''
<div class="wrap">
    <div id="container">
        <ul class="list">
             <li class="item-0">first item</li>
             <li class="item-1"><a href="link2.html">second item</a></li>
             <li class="item-0 active"><a href="link3.html"><span class="bold">third item</span></a></li>
             <li class="item-1 active"><a href="link4.html">fourth item</a></li>
             <li class="item-0"><a href="link5.html">fifth item</a></li>
         </ul>
     </div>
 </div>
'''
from pyquery import PyQuery as pq
doc = pq(html)
items = doc('.list')
container = items.parent()
print(type(container))
print(container)
```

运行结果：

```python
<class 'pyquery.pyquery.PyQuery'>
<div id="container">
    <ul class="list">
         <li class="item-0">first item</li>
         <li class="item-1"><a href="link2.html">second item</a></li>
         <li class="item-0 active"><a href="link3.html"><span class="bold">third item</span></a></li>
         <li class="item-1 active"><a href="link4.html">fourth item</a></li>
         <li class="item-0"><a href="link5.html">fifth item</a></li>
     </ul>
 </div>
```

在这里我们首先用`.list`选取了class为list的节点，然后调用了parent()方法，得到其父节点，类型依然是PyQuery类型。

这里的父节点是该节点的直接父节点，也就是说，它不会再去查找父节点的父节点，即祖先节点。

但是如果我们想获取某个祖先节点怎么办呢？可以用parents()方法。

```python
from pyquery import PyQuery as pq
doc = pq(html)
items = doc('.list')
parents = items.parents()
print(type(parents))
print(parents)
```

运行结果：

```python
<class 'pyquery.pyquery.PyQuery'>
<div class="wrap">
    <div id="container">
        <ul class="list">
             <li class="item-0">first item</li>
             <li class="item-1"><a href="link2.html">second item</a></li>
             <li class="item-0 active"><a href="link3.html"><span class="bold">third item</span></a></li>
             <li class="item-1 active"><a href="link4.html">fourth item</a></li>
             <li class="item-0"><a href="link5.html">fifth item</a></li>
         </ul>
     </div>
 </div>
 <div id="container">
        <ul class="list">
             <li class="item-0">first item</li>
             <li class="item-1"><a href="link2.html">second item</a></li>
             <li class="item-0 active"><a href="link3.html"><span class="bold">third item</span></a></li>
             <li class="item-1 active"><a href="link4.html">fourth item</a></li>
             <li class="item-0"><a href="link5.html">fifth item</a></li>
         </ul>
     </div>
```

在这里我们调用了parents()方法，可以看到输出结果有两个，一个是class为wrap的节点，一个是id为container的节点，也就是说，parents()方法会返回所有的祖先节点。

如果我们想要筛选某个祖先节点的话可以向parents()方法传入CSS选择器，这样就会返回祖先节点中符合CSS选择器的节点。

```python
parent = items.parents('.wrap')
print(parent)
```

运行结果：

```python
<div class="wrap">
    <div id="container">
        <ul class="list">
             <li class="item-0">first item</li>
             <li class="item-1"><a href="link2.html">second item</a></li>
             <li class="item-0 active"><a href="link3.html"><span class="bold">third item</span></a></li>
             <li class="item-1 active"><a href="link4.html">fourth item</a></li>
             <li class="item-0"><a href="link5.html">fifth item</a></li>
         </ul>
     </div>
 </div>
```

可以看到输出结果就少了一个节点，只保留了class为wrap的节点。

### 兄弟节点

在上面我们说明了子节点和父节点的用法，还有一种节点那就是兄弟节点，如果要获取兄弟节点可以使用siblings()方法。我们还是以上面的HTML代码为例来感受一下：

```python
from pyquery import PyQuery as pq
doc = pq(html)
li = doc('.list .item-0.active')
print(li.siblings())
```

在这里我们首先选择了class为list的节点内部的class为item-0和active的节点，也就是第三个li节点。那么很明显它的兄弟节点有四个，那就是第一、二、四、五个li节点。

运行结果：

```python
<li class="item-1"><a href="link2.html">second item</a></li>
<li class="item-0">first item</li>
<li class="item-1 active"><a href="link4.html">fourth item</a></li>
<li class="item-0"><a href="link5.html">fifth item</a></li>
```

可以看到运行结果也正是我们刚才所说的四个兄弟节点。

如果要筛选某个兄弟节点，我们依然可以向方法传入CSS选择器，这样就会从所有兄弟节点中挑选出符合条件的节点了。

```python
from pyquery import PyQuery as pq
doc = pq(html)
li = doc('.list .item-0.active')
print(li.siblings('.active'))
```
在这里我们筛选了class为active的节点，通过刚才的结果我们可以观察到class为active的兄弟节点只有第四个li节点，所以结果应该是一个。

运行结果：

```python
<li class="item-1 active"><a href="link4.html">fourth item</a></li>
```

## 遍历

我们刚才可以观察到，PyQuery的选择结果可能是多个节点，可能是单个节点，类型都是PyQuery类型，并没有返回像BeautifulSoup一样的列表。

对于单个节点来说，我们可以直接打印输出，也可直接转成字符串。

```python
from pyquery import PyQuery as pq
doc = pq(html)
li = doc('.item-0.active')
print(li)
print(str(li))
```

运行结果：

```python
<li class="item-0 active"><a href="link3.html"><span class="bold">third item</span></a></li>
<li class="item-0 active"><a href="link3.html"><span class="bold">third item</span></a></li>
```

对于多个节点的结果，我们就需要遍历来获取了，例如这里我们把每一个li节点进行遍历,，需要调用items()方法。

```python
from pyquery import PyQuery as pq
doc = pq(html)
lis = doc('li').items()
print(type(lis))
for li in lis:
    print(li, type(li))
```

运行结果：

```python
<class 'generator'>
<li class="item-0">first item</li>
<class 'pyquery.pyquery.PyQuery'>
<li class="item-1"><a href="link2.html">second item</a></li>
<class 'pyquery.pyquery.PyQuery'>
<li class="item-0 active"><a href="link3.html"><span class="bold">third item</span></a></li>
<class 'pyquery.pyquery.PyQuery'>
<li class="item-1 active"><a href="link4.html">fourth item</a></li>
<class 'pyquery.pyquery.PyQuery'>
<li class="item-0"><a href="link5.html">fifth item</a></li>
<class 'pyquery.pyquery.PyQuery'>
```
在这里我们可以发现调用items()方法后，会得到一个生成器，遍历一下，就可以逐个得到li节点对象了，它的类型也是PyQuery类型，所以每个li标签还可以调用前面所说的方法进行选择，比如继续查询子节点，寻找某个祖先节点等等，非常灵活。

