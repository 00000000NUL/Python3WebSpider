# Redis存储

在本节我们介绍一下Python的Redis操作，在本节开始之前请确保你已经安装好了Redis及Python Redis库。

## Redis和StrictRedis

Redis库提供两个类Redis和StrictRedis用于实现Redis的命令操作。

StrictRedis实现了绝大部分官方的命令，参数也一一对应，比如set方法就对应Redis命令的set方法。而Redis是StrictRedis的子类，它的主要功能是用于向后兼容旧版本Redis类里面有几个方法为了做兼容，将方法改写，比如lrem方法就将value和num的位置互换，和Redis命令行的命令参数不一致。 

官方推荐使用StrictRedis，所以本节我们也用StrictRedis类的相关方法作演示。

## 连接Redis

当前在本地我已经安装了Redis并运行在6379端口，密码设置为foobared。

那么可以用如下示例连接Redis并测试：

```python
from redis import StrictRedis

redis = StrictRedis(host='localhost', port=6379, db=0, password='foobared')
redis.set('name', 'Bob')
print(redis.get('name'))
```

在这里我们传入了Redis的地址，运行端口，使用的数据库，密码信息。在默认不传的情况下，这四个参数分别为localhost、6379、0、None。现在我们声明了一个StrictRedis对象，然后接下来调用了set方法，设置一个键值对，然后在将其获取打印。

运行结果：

```
b'Bob'
```

这样就说明我们连接成功，并可以执行set()、get()操作了。

当然我们还可以使用ConnectionPool来连接，示例如下：

```python
from redis import StrictRedis, ConnectionPool

pool = ConnectionPool(host='localhost', port=6379, db=0, password='foobared')
redis = StrictRedis(connection_pool=pool)
```

这样的连接效果是一样的，观察源码可以发现StrictRedis内其实就是用host、port等参数又构造了一个ConnectionPool，所以我们直接将ConnectionPool当参数传给StrictRedis也是一样的。

另外ConnectionPool还支持通过URL来构建，URL的格式支持如下三种：

```python
redis://[:password]@localhost:6379/0
rediss://[:password]@localhost:6379/0
unix://[:password]@/path/to/socket.sock?db=0
```

这三种URL分别表示创建Redis TCP连接、Redis TCP+SSL连接、Redis Unix Socket连接，我们只需要构造上面任意一种连接URL即可，其中password部分如果有则可以写，没有可以省略，下面我们再用URL连接演示一下：

```python
url = 'redis://:foobared@localhost:6379/0'
pool = ConnectionPool.from_url(url)
redis = StrictRedis(connection_pool=pool)
```

我们首先声明了一个Redis连接字符串，然后调用from_url()方法创建一个ConnectionPool，然后将其传给StrictRedis即可完成连接，所以使用URL的连接方式还是比较方便的。

## KEY操作

在这里主要将Key的一些判断和操作方法做下总结：

| 方法 | 作用 |参数说明 | 示例 | 示例说明 | 示例结果 |
| ---- | ---- | ---- | ---- | ---- | ---- |
| exists(name) | 判断一个key是否存在 | name: key名 | `redis.exists('name')` | 是否存在name这个key | True |
| delete(name) | 删除一个key | name: key名 | `redis.delete('name')` | 删除name这个key | 1 |
| type(name) | 判断key类型 | name: key名 | `redis.type('name')` | 判断name这个key类型 | b'string' |
| keys(pattern) | 获取所有符合规则的key | pattern: 匹配规则 | `redis.keys('n*')` | 获取所有以n开头的key | [b'name'] |
| randomkey() | 获取随机的一个key |  | `randomkey()` | 获取随机的一个key | b'name' |
| rename(src, dst) | 将key重命名 | src: 原key名 dst: 新key名 | `redis.rename('name', 'nickname')` | 将name重命名为nickname | True |
| dbsize() | 获取当前数据库中key的数目 |  | `dbsize()` | 获取当前数据库中key的数目 | 100 |
| expire(name, time) | 设定key的过期时间，单位秒 | name: key名 time: 秒数 | `redis.expire('name', 2)` | 将name这key的过期时间设置2秒 | True |
| ttl(name) | 获取key的过期时间，单位秒，-1为永久不过期 | name: key名 | `redis.ttl('name')` | 获取name这key的过期时间 | -1 |
| move(name, db) | 将key移动到其他数据库 | name: key名 db: 数据库代号 | `move('name', 2)` | 将name移动到2号数据库 | True |
| flushdb() | 删除当前选择数据库中的所有key |  | `flushdb()` | 删除当前选择数据库中的所有key | True |
| flushall() | 删除所有数据库中的所有key |  | `flushall()` | 删除所有数据库中的所有key | True |

## String操作

| 方法 | 作用 |参数说明 | 示例 | 示例说明 | 示例结果 |
| ---- | ---- | ---- | ---- | ---- | ---- |
| set(name, value) | 给数据库中名称为key的string赋予值value | name: key名 value: 值 | `redis.set('name', 'Bob')` | 给name这个key赋值为Bob | True |
| get(name) | 返回数据库中名称为key的string的value | name: key名 | `redis.get('name')` | 返回name这个key的value | b'Bob' |
| getset(name, value) | 给数据库中名称为key的string赋予值value并返回上次的value | name: key名 value: 新值 | `redis.getset('name', 'Mike')` | 赋值name为Mike并得到上次的value | b'Bob' |
| mget(keys, *args) | 返回多个key对应的value | keys: key的列表 | `redis.mget(['name', 'nickname'])` | 返回name和nickname的value | [b'Mike', b'Miker'] |
| setnx(name, value) | 如果key不存在才设置value | name: key名 | `redis.setnx('newname', 'James')` | 如果newname这key不存在则设置值为James | 第一次运行True，第二次False |
| setex(name, time, value) | 设置可以对应的值为string类型的value，并指定此键值对应的有效期 | name: key名 time: 有效期 value: 值 | `redis.setex('name', 1, 'James')` | 将name这key的值设为James，有效期1秒 | True |
| setrange(name, offset, value) | 设置指定key的value值的子字符串 | name: key名 offset: 偏移量 value: 值 | `redis.set('name', 'Hello') redis.setrange('name', 6, 'World')` | 设置name为Hello字符串，并在index为6的位置补World | 11，修改后的字符串长度 |
| mset(mapping) | 批量赋值 | mapping: 字典 |  `redis.mset({'name1': 'Durant', 'name2': 'James'})` | 将name1设为Durant，name2设为James | True |
| msetnx(mapping) | key均不存在时才批量赋值 | mapping: 字典 | `redis.msetnx({'name3': 'Smith', 'name4': 'Curry'})` | 在name3和name4均不存在的情况下才设置二者值 | True |
| incr(name, amount=1) | 名称为key的value增值操作，默认1，key不存在则被创建并设为amount | name: key名 amount:增长的值 | `redis.incr('age', 1)` | age对应的值增1，若不存在则会创建并设置为1 | 1，即修改后的值 |
| decr(name, amount=1) | 名称为key的value减值操作，默认1，key不存在则被创建并设置为-amount | name: key名 amount:减少的值 | `redis.decr('age', 1)` | age对应的值减1，若不存在则会创建并设置为-1 | -1，即修改后的值 |



setnx(key, value)：设置key对应的值为string类型的value，如果key已经存在，返回0，nx是not exist的意思
setex(key, time, value)：设置可以对应的值为string类型的alue，并指定此键值对应的有效期
Setrange(key,N,value) ：设置指定key的alue值的子字符串
mset(key N, value N)：批量设置多个string的值
msetnx(key N, value N)：一次设置多个key的值，成功返回ok表示所有的值都设置了，失败返回0表示没有任何值被设置，但是不会覆盖已经存在的key
incr(key)：名称为key的string增1操作
incrby(key, integer)：名称为key的string增加integer
decr(key)：名称为key的string减1操作
decrby(key, integer)：名称为key的string减少integer
append(key, value)：名称为key的string的值附加value
substr(key, start, end)：返回名称为key的string的value的子串
getrange(key,start,end)：获取key的value值从start到end的子字符串，







