# ScrapydClient的使用

在Scrapyd提供的接口中，我们会发现有一个实现起来还是有困难，那就是部署，因为部署的时候我们需要先将项目打包成Egg文件，那么这一步做起来其实是比较繁琐的，我们也没有必要再去费心思写一个打包项目的脚本了，这里其实也有现成的工具，它叫做ScrapydClient。

本节我们就来简单介绍下使用ScrapydClient部署Scrapy项目的方法，在使用之前，需要先确保ScrapydClient已经正确安装，安装方式可以参考第一章的内容。

## ScrapydClient的功能

ScrapydClient为了方便Scrapy项目的部署，提供两个功能：
* 将项目打包成Egg文件。
* 将打包生成的Egg文件通过addversion.json接口部署到Scrapyd上。

也就是说，ScrapydClient帮我们把部署全部实现了，我们不需要再去关心Egg文件是怎样生成的，也不需要再去读Egg文件并请求接口上传了，这一切的操作只需要执行一个命令即可一键部署。

## ScrapydClient部署

要部署Scrapy项目，我们首先需要修改一下项目的配置文件，例如我们之前写的Scrapy微博爬虫项目，在项目的第一层会有一个scrapy.cfg文件，它的内容如下：

```
# Automatically created by: scrapy startproject
#
# For more information about the [deploy] section see:
# https://scrapyd.readthedocs.org/en/latest/deploy.html

[settings]
default = weibo.settings

[deploy]
#url = http://localhost:6800/
project = weibo
```

在这里我们需要配置一下deploy部分，例如我们要将项目部署到120.27.34.25的Scrapyd上，就需要修改为如下内容：

```
[deploy]
url = http://120.27.34.25:6800/
project = weibo
```

这样我们再在scrapy.cfg文件所在路径执行如下命令：

```
scrapyd-deploy
```

运行结果如下：

```
Packing version 1501682277
Deploying to project "weibo" in http://120.27.34.25:6800/addversion.json
Server response (200):
{"status": "ok", "spiders": 1, "node_name": "datacrawl-vm", "project": "weibo", "version": "1501682277"}
```

返回这样的结果就代表部署成功了。

我们也可以指定项目版本，如果不指定的话默认为当前时间戳，指定的话通过version参数传递即可，例如：

```
scrapyd-deploy --version 201707131455
```

值得注意的是在Python3的Scrapyd 1.2.0版本中我们不要指定版本号为带字母的字符串，需要为纯数字，否则可能会出现报错。

另外如果我们有多台主机，我们可以配置各台主机的别名，例如可以修改配置文件为：

```
[deploy:vm1]
url = http://120.27.34.24:6800/
project = weibo

[deploy:vm2]
url = http://139.217.26.30:6800/
project = weibo
```

有多台主机的话就在此统一配置，一台主机对应一组配置，在deploy后面加上主机的别名即可，这样如果我们想将项目部署到IP为139.217.26.30的vm2主机，我们只需要执行如下命令：

```
scrapyd-deploy vm2
```

这样我们就可以将项目部署到名称为vm2的主机上了。

如此一来，如果我们有多台主机，我们只需要在scrapy.cfg文件中配置好各台主机的Scrapyd地址，然后调用scrapyd-deploy命令加主机名称即可实现部署，非常方便。

如果Scrapyd设置了访问限制的话，我们可以在配置文件中加入用户名和密码的配置，同时端口修改一下，修改成Nginx代理端口，如在第一章我们使用的是6801，那么这里就需要改成6801，修改如下：

```
[deploy:vm1]
url = http://120.27.34.24:6801/
project = weibo
username = admin
password = admin

[deploy:vm2]
url = http://139.217.26.30:6801/
project = weibo
username = germey
password = germey
```

这样通过加入username和password字段我们就可以在部署时自动进行Auth验证，然后成功实现部署。
